import{config}from"../config.js";null!==ice.data("adminTab")&&(config.tab=ice.data("adminTab"));class admin{constructor(t){var i=this;if(this.config=config,this.callback=t,this.json={},this.moveLine=ice(".adminXL-menu-move"),this.menuList=ice(".adminXL-sidebar a"),config.tab){ice(".adminXL-header").append('<div class="adminXL-tab"><div class="adminXL-tab-left"><i class="icon ice-arrow-line-l"></i></div><div class="adminXL-tab-box"></div><div class="adminXL-tab-right"><i class="icon ice-arrow-line-r"></i></div></div>'),ice(".adminXL-content").addCss("adminXL-tab-iframe"),this.menuList.each(function(){this.pjax=!0}),ice(".adminXL-menu a").each(function(){this.pjax=!0}),this.tab={tabEl:ice(".adminXL-tab-box"),leftBtn:ice(".adminXL-tab-left"),rightBtn:ice(".adminXL-tab-right"),contentEl:ice(".adminXL-content"),struct:{},log:{},active:{url:config.index},open(t,e){var s=this;if("object"==typeof t?t.id=t.id?t.id:t.url:(t={url:t},t.title=e,t.id=t.url),t.title=t.title||"加载中",t.close=void 0===t.close||t.close,this.struct[t.id]){if(ice(this.struct[t.id].tabEl).hasCss("active"))return;for(var n in this.struct)this.struct[n].active=!1;this.struct[t.id].active=!0,ice(".active",this.tabEl).delCss("active"),ice(".active",this.contentEl).delCss("active"),ice(this.struct[t.id].tabEl).addCss("active"),ice(this.struct[t.id].contentEl).addCss("active"),this.struct[t.id].w.tabActive&&this.struct[t.id].w.tabActive(this.struct[t.id],this.struct),this.success&&this.success(this.struct[t.id]),i.callback&&i.callback(t.url,this.struct[t.id]);var c=this.struct[t.id].tabEl.offsetLeft-this.tabEl[0].scrollLeft;c>this.tabEl[0].offsetWidth?this.tabEl[0].scrollLeft=c-this.tabEl[0].offsetWidth+this.struct[t.id].tabEl.offsetWidth:c<=0&&(this.tabEl[0].scrollLeft=this.struct[t.id].tabEl.offsetLeft-this.tabEl[0].offsetWidth/2)}else{this.struct[t.id]=this.struct[t.id]?this.struct[t.id]:t;var a=ice.c("div");a.className="adminXL-tab-item",a.onclick=function(){s.open(t.id)},a.onmouseover=function(){a.oncontextmenu=function(i){s.sel=s.struct[t.id],ice(".adminXL-tab-menu").show(),ice(".adminXL-tab-menu-box").css({left:window.event.clientX+"px",top:window.event.clientY+"px"}),i.preventDefault()}};var o=ice.c("span");if(o.className="adminXL-tab-title",o.innerHTML=t.title,a.append(o),this.tabEl.append(a),0!=t.close){var l=ice.c("span");l.className="adminXL-tab-close",l.innerHTML="✕",l.onclick=function(){if(ice.sp(),ice(a).del(),ice(s.struct[t.id].contentEl).del(),s.struct[t.id].active){var i,e=0,n=[];for(var c in s.struct)n.push(s.struct[c].id),s.struct[c].id===t.id&&(i=e),e++;i?s.open(n[i+1]?n[i+1]:n[i-1]):n.length>1&&s.open(n[i+1])}delete s.struct[t.id],s.logInit()},a.append(l)}this.struct[t.id].tabEl=a;var r=ice.c("iframe");r.className="adminXL-iframe",r.setAttribute("frameborder",0),r.setAttribute("allowfullscreen",!0),r.src=config.host+t.url,this.struct[t.id].contentEl=r,this.contentEl.append(r),r.contentWindow.adminTab=this,this.struct[t.id].w=r.contentWindow,this.struct[t.id].d=r.contentDocument,this.struct[t.id].tabTitle=o,r.onload=function(){if(r.contentWindow.adminTab=s,"加载中"==t.title){var e=ice(".adminXL-title span",r.contentDocument);e.length?t.title=e.html():t.title=ice("title",r.contentDocument).html(),o.innerHTML=t.title}s.linkInit(r.contentDocument),s.success&&s.success(s.struct[t.id]),i.callback&&i.callback(t.url,s.struct[t.id])},this.open(t.id)}this.active=t,this.active.tabEl=this.struct[t.id].tabEl,this.active.contentEl=this.struct[t.id].contentEl,this.active.tabTitle=this.struct[t.id].tabTitle,this.active.struct=this.struct[t.id],i.menuActive(),this.logInit()},render(t){var i=t?this.struct[t].contentEl:this.struct[this.active.id].contentEl,e=ice(i).clone()[0];i.parentNode.replaceChild(e,i),e.contentWindow.adminTab=this,this.active.contentEl=e,this.struct[this.active.id].w=e.contentWindow,this.struct[this.active.id].d=e.contentDocument,this.struct[this.active.id].contentEl=e},setTitle(t){this.active.tabTitle.innerHTML=t},logInit(){for(var t in this.log={},this.struct)this.log[t]={id:t,url:this.struct[t].url,title:this.struct[t].title,close:this.struct[t].close,active:this.struct[t].active};ice.data("adminTabLog",this.log)},close(t){var i,e;if(void 0!==t){if(!this.struct[t])return;if(!this.struct[t].close)return;if(this.active.id===t)return this.close();i=this.struct[t].tabEl,e=this.struct[t].contentEl}else i=this.active.tabEl,e=this.active.contentEl,t=this.active.id,this.openLeft();ice(i).del(),ice(e).del(),delete this.struct[t],this.logInit()},openLeft(){var t=[],i=0;for(var e in this.struct)i?i.push(e):t.push(e),this.struct[e].active&&(i=[]);t.pop(),t.length?this.open(t.pop()):i.length&&this.open(i[0])},openRight(){var t,i;for(var e in this.struct){if(t=e,i)break;this.struct[e].active&&(i=1)}t&&this.open(t)},leftMove(){var t=this;!function i(e){e--,e&&setTimeout(()=>{t.tabEl[0].scrollLeft+=20,i(e)},10)}(15)},rightMove(){var t=this;!function i(e){e--,e&&setTimeout(()=>{t.tabEl[0].scrollLeft-=20,i(e)},10)}(15)},linkInit(t){var i=this;ice("a",t).on("click",function(){var t=ice(this),e=t.attr("href");"_blank"!=t.attr("target")&&"false"!=t.attr("data-tab")&&"false"!=t.attr("data-pjax")&&"#"!=e&&"javascript:"!=e.trim().toLowerCase().slice(0,11)&&(console.log(3),ice.pd(),i.open(e,t.attr("data-title")))})},init(){var t=this;this.linkInit(ice(".adminXL-menu")),i.menuList.on("click",function(){var e=ice(this).attr("href");"_blank"!=ice(this).attr("target")&&"#"!=e&&"javascript:"!=e.trim().toLowerCase().slice(0,11)&&(ice.pd(),ice(".adminXL-sidebar-menu .active").delCss("active"),i.moveLine.css("top",ice(this.parentNode).page().y+"px"),t.open(ice(this).attr("href"),ice("span",this).html()))}),ice(".adminXL-tab-left").click(function(){t.rightMove()}),ice(".adminXL-tab-right").click(function(){t.leftMove()});var e=ice.c("div");e.className="adminXL-tab-menu",e.innerHTML='\n\t\t\t\t\t<div class="adminXL-tab-menu-box">\n\t\t\t\t\t\t<div class="adminXL-tab-menu-item">关闭</div>\n\t\t\t\t\t\t<div class="adminXL-tab-menu-item">关闭左侧标签</div>\n\t\t\t\t\t\t<div class="adminXL-tab-menu-item">关闭右侧标签</div>\n\t\t\t\t\t\t<div class="adminXL-tab-menu-item">关闭其它标签</div>\n\t\t\t\t\t\t<div class="adminXL-tab-menu-item">重新加载</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t',ice("body").append(e),ice(".adminXL-tab-menu-item").i(0).click(function(){t.close(t.sel.id)}),ice(".adminXL-tab-menu-item").i(1).click(function(){var i;for(var e in t.struct){if(t.struct[e].id===t.sel.id){i&&t.open(t.sel.id);break}t.struct[e].active&&(i=!0),t.close(t.struct[e].id)}}),ice(".adminXL-tab-menu-item").i(2).click(function(){var i,e;for(var s in t.struct)t.struct[s].id===t.sel.id?i=!0:i&&(t.struct[s].active&&(e=!0),t.close(t.struct[s].id));e&&t.open(t.sel.id)}),ice(".adminXL-tab-menu-item").i(3).click(function(){for(var i in t.struct)t.struct[i].id!==t.sel.id&&t.close(t.struct[i].id);t.open(t.sel.id)}),ice(".adminXL-tab-menu-item").i(4).click(function(){t.render(t.sel.id)}),ice("body").on("click",function(){ice(e).hide()})}};var e=ice.data("adminTabLog");if(e&&Object.keys(e).length){var s;for(var n in e)this.tab.open(ice.cloneObj(e[n])),e[n].active&&(s=ice.cloneObj(e[n]));setTimeout(()=>{this.tab.open(s)},50)}}if(this.sidebar={open(){ice(".adminXL-toggle").delCss("open"),ice(".adminXL-page").delCss("adminXL-sidebar-close"),ice(".adminXL-sidebar").delCss("open")},close(){ice(".adminXL-toggle").addCss("open"),ice(".adminXL-page").addCss("adminXL-sidebar-close"),ice(".adminXL-sidebar").addCss("open")}},ice(".adminXL-toggle").click(function(){ice(this).toggleCss("open","close"),ice(".adminXL-page").toggleCss("adminXL-sidebar-close"),ice(".adminXL-sidebar").toggleCss("open","close")}),ice(".adminXL-toggle-right").click(function(){ice(".adminXL-menu").toggleCss("open","close"),ice.toggleCss(this,"open")}),this.menuInit(),this.pjax({el:".adminXL-content",js:config.js,empty:config.error,success:function(t,e){i.menuActive(),ice(".dropdown").delCss("open"),ui.init(),i.callback&&i.callback(t,e)}}),config.tab)Object.keys(this.tab.log).length||this.tab.open({id:config.index,url:config.index,title:'<i class="icon ice-home"></i>',close:!1}),this.tab.init();else{var c=ice.getUrl("__path");c?this.open(c):this.open(config.index)}return this}menuActive(){var t=this;this.menuList.each(function(){var i,e=ice(this).attr("href"),s=config.tab?t.tab.active.url:window.location.pathname+window.location.search;if(e===s?i=1:s.indexOf(e)>-1&&(i=2),i){ice(".adminXL-sidebar-menu .active").delCss("active"),ice(this).addCss("active");var n=this.parentNode.parentNode;if(ice(n).hasCss("adminXL-menu-dropdown")&&ice(n).delCss("tree-close").addCss("tree-open").show().parent().delCss("tree-close").addCss("tree-open"),t.moveLine.css("top",ice(this.parentNode).page().y+"px"),1===i)return!1}})}menuInit(){var t=this;this.menuList.each(function(){this.pjax=!0}),this.menuList.on("click",function(){if(ice.web().w<=768&&(ice(".adminXL-toggle").toggleCss("open","close"),ice(".adminXL-page").toggleCss("adminXL-sidebar-close"),ice(".adminXL-sidebar").toggleCss("open","close")),!config.tab){var i=ice(this).attr("href"),e=ice(this).attr("data-pjax");if("_blank"==ice(this).attr("target")||"false"==e||"#"==i||"javascript:"==i.trim().toLowerCase().slice(0,11))return;ice.pd(),t.open(ice(this).attr("href"))}}),ice.tree({el:"#adminXL-tree"}),this.menuActive(),this.menuList.on("mouseover",function(){t.moveLine.css("top",ice(this).page().y-ice.scroll("y")+"px")}),this.menuList.on("mouseout",function(){t.moveLine.css("top",ice(".adminXL-sidebar-menu .active").page().y+"px")})}pjax(t){this.json=t||this.json,ice.pjax(this.json)}render(){this.pjax()}open(t){t=decodeURIComponent(t),this.json.url=config.host+t,this.pjax()}href(t){window.location.href=t}menu(t){if(t&&t.length){ice("#adminXL-tree").html("");var i=this,e="";for(var s of t)if(s.child&&s.child.length){var n="";for(var c of s.child)n+=`<li><a href="${c.url}"><span class="title">${c.name}</span></a></li>`;e+=`<li>\n\t\t\t\t\t<a href="javascript:;">\n\t\t\t\t\t\t<i class="icon ${s.icon}"></i>\n\t\t\t\t\t\t<span class="title">${s.name}</span>\n\t\t\t\t\t\t${s.dot?'<span class="tag tag-dot bg-'+s.dot+'"></span>':""}\n\t\t\t\t\t\t<span class="arrow"><i class="icon ice-arrow-line-r"></i></span>\n\t\t\t\t\t</a>\n\t\t\t\t\t<ul class="adminXL-menu-dropdown">\n\t\t\t\t\t\t${n}\n\t\t\t\t\t</ul>\n\t\t\t\t</li>`}else e+=`<li>\n\t\t\t\t\t<a href="${s.url}">\n\t\t\t\t\t\t<i class="icon ${s.icon}"></i>\n\t\t\t\t\t\t<span class="title">${s.name}</span>\n\t\t\t\t\t\t${s.dot?'<span class="tag tag-dot bg-'+s.dot+'"></span>':""}\n\t\t\t\t\t</a>\n\t\t\t\t</li>`;ice("#adminXL-tree").html(e),ice.tree({el:"#adminXL-tree",time:2}),this.menuInit(),ice("#adminXL-tree a").on("click",function(){var t=ice(this).attr("href"),e=ice(this).attr("data-pjax");if("_blank"!=ice(this).attr("target")&&"false"!=e&&"#"!=t&&"javascript:"!=t.trim().toLowerCase().slice(0,11))return ice.pd(),i.json.url=t,i.pjax(),!1})}}}window.adminXL=new admin(!!window.adminXLCallback&&window.adminXLCallback);